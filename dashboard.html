<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Status - Polar Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Dashboard Specific Styles */
        .dash-container { max-width: 900px; margin: 0 auto; padding: 2rem; position: relative; z-index: 2; }
        
        /* Status Tracker */
        .status-track { display: flex; justify-content: space-between; margin-bottom: 3rem; position: relative; }
        .status-track::before { content: ''; position: absolute; top: 15px; left: 0; width: 100%; height: 2px; background: #374151; z-index: 0; }
        .track-step { position: relative; z-index: 1; text-align: center; width: 100px; }
        .track-dot { width: 30px; height: 30px; border-radius: 50%; background: #111827; border: 2px solid #374151; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; color: #374151; font-size: 0.8rem; transition: all 0.3s; }
        .track-label { font-size: 0.8rem; color: #6b7280; }
        
        /* Active/Completed States (Cyan/Mint) */
        .track-step.active .track-dot { border-color: var(--polar-cyan); background: var(--polar-cyan); color: #000; box-shadow: 0 0 10px rgba(34, 211, 238, 0.3); }
        .track-step.active .track-label { color: var(--polar-cyan); font-weight: bold; }
        .track-step.completed .track-dot { border-color: var(--polar-mint); background: var(--polar-mint); color: #000; }
        .track-step.completed .track-label { color: var(--polar-mint); }

        /* Document File Row */
        .doc-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid #374151; }
        .doc-icon { font-size: 1.5rem; color: #ef4444; margin-right: 1rem; } /* PDF Red */
        .doc-check { color: var(--polar-mint); font-size: 1.2rem; }

        /* Action Card */
        .action-card { background: #1f2937; border: 1px solid #374151; border-radius: 12px; padding: 2rem; margin-top: 2rem; animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Reset Button Style */
        .reset-btn { 
            display: block; 
            margin: 3rem auto 0; 
            background: transparent; 
            border: 1px solid #ef4444; 
            color: #ef4444; 
            padding: 0.5rem 1rem; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.8rem; 
            transition: all 0.3s; 
        }
        .reset-btn:hover { background: #ef4444; color: white; }
    </style>
</head>
<body>

    <div id="leaf-background">
        <i class="fas fa-leaf bg-leaf bg-pos-left-1"></i>
        <i class="fas fa-leaf bg-leaf bg-pos-left-2"></i>
    </div>

    <nav>
        <div class="logo">
            <i class="fas fa-solar-panel"></i> 
            <span>Polar</span>
        </div>
        <div class="nav-links">
            <a href="index.html"><i class="fas fa-home"></i> <span>Home</span></a>
            <a href="knowledge.html"><i class="fas fa-book-open"></i> <span>Learn</span></a>
            <a href="assessment.html"><i class="fas fa-play-circle"></i> <span>Get Started</span></a>
            <a href="dashboard.html" class="active"><i class="fas fa-user-circle"></i> <span>My Status</span></a>
        </div>
        <div class="nav-spacer"></div>
    </nav>

    <main class="dash-container">
        <h1 style="color:white; margin-bottom: 0.5rem;">Hello, <span id="user-name" style="color:var(--polar-cyan)">Solar Hero</span></h1>
        <p style="color:#9ca3af; margin-bottom: 2rem;">Here is the status of your energy transition.</p>

        <div class="status-track">
            <div class="track-step completed">
                <div class="track-dot"><i class="fas fa-check"></i></div>
                <div class="track-label">Assessment</div>
            </div>
            <div class="track-step active" id="track-sign">
                <div class="track-dot">2</div>
                <div class="track-label">Sign Docs</div>
            </div>
            <div class="track-step" id="track-enea">
                <div class="track-dot">3</div>
                <div class="track-label">ENEA Review</div>
            </div>
            <div class="track-step" id="track-install">
                <div class="track-dot">4</div>
                <div class="track-label">Installation</div>
            </div>
        </div>

        <div id="dashboard-content"></div>

        <button onclick="resetData()" class="reset-btn">
            <i class="fas fa-trash-alt"></i> Reset Progress (PoC Only)
        </button>

    </main>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const data = JSON.parse(localStorage.getItem('ecopol_form_data') || '{}');
            if (data.fullname) document.getElementById('user-name').innerText = data.fullname.split(' ')[0];

            const status = localStorage.getItem('polar_dashboard_status') || 'empty';
            renderDashboard(status, data);
        });

        function renderDashboard(status, data) {
            const container = document.getElementById('dashboard-content');
            
            // --- STATE 0: EMPTY / START ---
            if (status === 'empty') {
                container.innerHTML = `
                    <div class="action-card" style="text-align:center;">
                        <i class="fas fa-solar-panel" style="font-size:3rem; color:var(--polar-cyan); margin-bottom:1rem;"></i>
                        <h2 style="color:white;">No Application Found</h2>
                        <p style="color:#9ca3af; margin-bottom:1.5rem;">Start the assessment to generate your personalized plan.</p>
                        <a href="assessment.html" class="btn btn-primary">Start Assessment</a>
                    </div>
                `;
                return;
            }

            // --- STATE 1: READY TO SIGN (Files Ready) ---
            if (status === 'ready_to_sign') {
                updateTracker(2);
                const cap = data.capacity || '5';
                
                // CONDITIONAL HTML FOR FIRE SAFETY (Only for 10kW)
                let fireSafetyHtml = '';
                if(cap === '10') {
                    fireSafetyHtml = `
                        <div class="doc-row" style="border-color: #f59e0b;">
                            <div style="display:flex; align-items:center;">
                                <i class="fas fa-fire-extinguisher doc-icon" style="color:#f59e0b"></i>
                                <div>
                                    <strong style="color:white; display:block;">Fire Safety Notice (Zgłoszenie PSP)</strong>
                                    <span style="color:#f59e0b; font-size:0.8rem;">Required for >6.5kW. Sent to Fire Expert.</span>
                                </div>
                            </div>
                            <span style="color:#f59e0b; font-size:0.8rem; border:1px solid #f59e0b; padding:2px 8px; border-radius:4px;">Pending Expert</span>
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div class="action-card">
                        <h2 style="color:white; margin-bottom:1rem;">Action Required: Sign & Submit</h2>
                        <p style="color:#9ca3af; margin-bottom:1.5rem;">We have prepared your application package. ${cap === '10' ? 'Since your system is >6.5kW, we have also initiated the Fire Safety protocol.' : ''}</p>
                        
                        <div class="doc-row">
                            <div style="display:flex; align-items:center;">
                                <i class="fas fa-file-pdf doc-icon"></i>
                                <div>
                                    <strong style="color:white; display:block;">ENEA Application (Zgłoszenie)</strong>
                                    <span style="color:#6b7280; font-size:0.8rem;">PDF • 1.2 MB • Generated Just Now</span>
                                </div>
                            </div>
                            <span class="btn btn-secondary" style="font-size:0.8rem; padding: 4px 10px; border-color:var(--polar-border); color: #9ca3af;">Preview</span>
                        </div>

                        <div class="doc-row">
                            <div style="display:flex; align-items:center;">
                                <i class="fas fa-file-code doc-icon" style="color:var(--polar-mint)"></i>
                                <div>
                                    <strong style="color:white; display:block;">Electrical Schematics</strong>
                                    <span style="color:var(--polar-mint); font-size:0.8rem;">Attached (${cap}kW Standard)</span>
                                </div>
                            </div>
                            <i class="fas fa-check-circle doc-check"></i>
                        </div>

                        ${fireSafetyHtml}

                        <div style="margin-top:2rem; text-align:right;">
                            <button onclick="signAndSubmit()" class="btn btn-primary" id="btn-sign">
                                <i class="fas fa-signature"></i> Digitally Sign & Submit
                            </button>
                        </div>
                    </div>
                `;
            }

            // --- STATE 2: SUBMITTED + INSTALLER OFFER ---
            if (status === 'enea_submitted') {
                updateTracker(3);
                
                // Show Fire Notice note if 10kW
                const cap = data.capacity || '5';
                const fireNote = cap === '10' ? `<p style="color:#f59e0b; font-size:0.8rem; margin-top:10px;"><i class="fas fa-info-circle"></i> We have also notified our Fire Safety Expert to review your building specs.</p>` : '';

                container.innerHTML = `
                    <div class="action-card" style="border-color:var(--polar-mint); background:rgba(110, 231, 183, 0.1);">
                        <div style="display:flex; gap:15px;">
                            <i class="fas fa-check-circle" style="font-size:2rem; color:var(--polar-mint);"></i>
                            <div>
                                <h3 style="color:white;">Application Submitted Successfully!</h3>
                                <p style="color:#d1d5db; font-size:0.9rem;">
                                    We have sent your signed documents to <strong>kontakt@operator.enea.pl</strong>.
                                    <br>According to "Silent Consent" rules, ENEA has 30 days to respond.
                                </p>
                                ${fireNote}
                            </div>
                        </div>
                    </div>

                    <div class="action-card">
                        <h3 style="color:var(--polar-cyan);">Next Step: Installation</h3>
                        <p style="color:#9ca3af; margin-bottom:1.5rem;">
                            Your paperwork is done, but you need a certified team to install the panels.
                            Would you like us to share your technical profile with top-rated installers in your area?
                        </p>
                        <button onclick="connectInstaller()" class="btn btn-primary" id="btn-install">
                            <i class="fas fa-hard-hat"></i> Yes, Find Me an Installer
                        </button>
                        <p style="font-size:0.8rem; color:#6b7280; margin-top:10px;">
                            By clicking "Yes", you agree to share your form data with 3rd party partners.
                        </p>
                    </div>
                `;
            }

            // --- STATE 3: INSTALLER CONTACTED ---
            if (status === 'installer_contacted') {
                updateTracker(4);
                container.innerHTML = `
                    <div class="action-card" style="text-align:center;">
                        <i class="fas fa-paper-plane" style="font-size:3rem; color:var(--polar-cyan); margin-bottom:1rem;"></i>
                        <h2 style="color:white;">Request Sent!</h2>
                        <p style="color:#d1d5db; margin-bottom:1.5rem;">
                            We have forwarded your profile to <strong>a certified representative</strong>.<br>
                            Our <strong>estimated</strong> price based on your area is: <strong>27 990 zł (for Equipment & Installation)</strong>.
                        </p>
                        <div style="background:rgba(255,255,255,0.05); padding:1rem; border-radius:8px; display:inline-block; text-align:left;">
                            <strong style="color:white;">What to expect:</strong>
                            <ul style="color:#9ca3af; margin-top:5px; padding-left:20px;">
                                <li>You will receive email quotes within 2-4 business days.</li>
                                <li>We offer to help you compare their offers (Price & Equipment).</li>
                                <li>We offer to help you choose the best one: they already have your ENEA approval status!</li>
                            </ul>
                        </div>
                        <div style="margin-top:2rem;">
                            <a href="knowledge.html" class="btn btn-secondary">Read about Equipment Types</a>
                        </div>
                    </div>
                `;
            }
        }

        // --- ACTIONS ---

        function signAndSubmit() {
            const btn = document.getElementById('btn-sign');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing & Sending...';
            btn.disabled = true;

            setTimeout(() => {
                localStorage.setItem('polar_dashboard_status', 'enea_submitted');
                // Pass data back so render can see capacity
                const data = JSON.parse(localStorage.getItem('ecopol_form_data') || '{}');
                renderDashboard('enea_submitted', data);
            }, 2000);
        }

        function connectInstaller() {
            const btn = document.getElementById('btn-install');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            btn.disabled = true;

            setTimeout(() => {
                localStorage.setItem('polar_dashboard_status', 'installer_contacted');
                const data = JSON.parse(localStorage.getItem('ecopol_form_data') || '{}');
                renderDashboard('installer_contacted', data);
            }, 1500);
        }

        function updateTracker(step) {
            document.querySelectorAll('.track-step').forEach(el => {
                el.classList.remove('active', 'completed');
            });
            const steps = ['dummy', 'track-sign', 'track-enea', 'track-install'];
            for(let i=1; i<=3; i++) {
                const el = document.getElementById(steps[i]);
                if (i < step) el.classList.add('completed');
                if (i === step) el.classList.add('active');
            }
            if(step === 4) {
                document.getElementById('track-install').classList.add('active'); 
                document.getElementById('track-enea').classList.add('completed');
            }
        }

        // --- RESET DATA FUNCTION ---
        function resetData() {
            if(confirm("Are you sure? This will delete all form data and reset the dashboard demo.")) {
                localStorage.removeItem('ecopol_form_data');
                localStorage.removeItem('application_status');
                localStorage.removeItem('polar_dashboard_status');
                window.location.reload();
            }
        }
    </script>
</body>
</html>